---
const clientId = import.meta.env.PUBLIC_SPOTIFY_CLIENT_ID as string | undefined;
const redirectUri = 'http://localhost:3000/callback';
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Spotify Callback (PKCE) — Dev Only</title>
    <meta name="robots" content="noindex,nofollow" />
    <style>
      :root { color-scheme: dark light; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; padding: 2rem; }
      .card { max-width: 840px; margin: 0 auto; border: 1px solid #4443; border-radius: 12px; padding: 1.25rem; }
      pre { background: #0000000d; padding: 1rem; border-radius: 8px; overflow: auto; }
      .ok { color: #16a34a; }
      .err { color: #dc2626; }
      code { white-space: pre-wrap; word-break: break-all; }
      a.btn { display: inline-block; padding: .6rem 1rem; border-radius: .6rem; border: 1px solid #4443; text-decoration: none; }
    </style>
  </head>
  <body>
    <div class="card" id="cfg" data-client-id={clientId} data-redirect-uri={redirectUri}>
      <h1>Spotify Callback (PKCE) — Dev Only</h1>
      <p>This page exchanges the authorization code for tokens and shows the <strong>refresh_token</strong> so you can store it in your <code>.env</code>.</p>
      <ol>
        <li>Copy the <strong>refresh_token</strong> value below.</li>
        <li>Add it to your <code>.env</code> as <code>SPOTIFY_REFRESH_TOKEN</code>.</li>
        <li>Restart the dev server.</li>
      </ol>
      <pre id="out" aria-live="polite">Parsing callback…</pre>
      <p><a class="btn" href="/">Back to home</a></p>
    </div>

    <script is:inline>
      const root = document.getElementById('cfg');
      const clientId = root?.dataset.clientId;
      const redirectUri = root?.dataset.redirectUri;
      const out = document.getElementById('out');
      const log = (obj) => out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);

      (async () => {
        try {
          const url = new URL(window.location.href);
          const errParam = url.searchParams.get('error');
          if (errParam) {
            return log({ error: errParam });
          }

          const code = url.searchParams.get('code');
          const returnedState = url.searchParams.get('state');
          const storedState = sessionStorage.getItem('pkce_state');
          const codeVerifier = sessionStorage.getItem('pkce_code_verifier');

          if (!code) return log('Missing ?code in callback URL.');
          if (!codeVerifier) return log('Missing code_verifier (session expired or different tab).');
          if (!returnedState || returnedState !== storedState) return log('State mismatch.');

          if (!clientId || !redirectUri) {
            return log('Missing configuration (clientId/redirectUri).');
          }

          const body = new URLSearchParams({
            client_id: clientId,
            grant_type: 'authorization_code',
            code,
            redirect_uri: redirectUri,
            code_verifier: codeVerifier
          });

          const resp = await fetch('https://accounts.spotify.com/api/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body
          });
          const json = await resp.json();
          if (!resp.ok) {
            return log({ status: resp.status, error: json });
          }

          const { refresh_token } = json;
          if (!refresh_token) {
            return log({ message: 'No refresh_token returned', json });
          }

          // Clean sensitive items from session storage
          sessionStorage.removeItem('pkce_state');
          sessionStorage.removeItem('pkce_code_verifier');

          log({
            message: 'Copy this refresh_token to your .env as SPOTIFY_REFRESH_TOKEN',
            refresh_token,
            note: 'After saving it, remove /login and /callback pages or keep them dev-only.'
          });
        } catch (e) {
          log({ error: String(e) });
        }
      })();
    </script>
  </body>
</html>
